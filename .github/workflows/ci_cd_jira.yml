name: Create Jira issue on PR open
on:
  pull_request:
    types: [ opened ]
env:
  JIRA_URL: ${{ secrets.JIRA_URL }}
  PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
  ISSUE_TYPE: ${{ secrets.JIRA_ISSUE_TYPE }}
  JIRA_AUTH: ${{ secrets.JIRA_AUTH }}
jobs:
  create_jira_issue:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR details
        id: pr-details
        run: |
          echo "branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "description=${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
          echo "assignee=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "reviewers=${{ join(github.event.pull_request.requested_reviewers.*.login, ',') }}" >> $GITHUB_OUTPUT
      - name: Get collaborators
        id: get-collaborators
#        env:
#          COLLABORATORS_JSON: ${{ secrets.JIRA_GITHUB_MAPPING }}
        run: |
          # Retrieve the secret value and save it to a file
          echo "${{ secrets.JIRA_GITHUB_MAPPING }}" > jira-github-mapping.json

          # Set the file contents as an output variable
          echo "mapped-collaborators=$(cat jira-github-mapping.json)">> $GITHUB_OUTPUT
      - name: Create Jira issue for assignee
        id: create-assigned-issue
        env:
          DESCRIPTION: ${{ steps.pr-details.outputs.description }}
          ASSIGNEE: ${{ steps.pr-details.outputs.assignee }}
          COLLABORATORS: ${{ steps.get-collaborators.outputs.mapped-collaborators }}
        run: |
          key=${{ env.ASSIGNEE }}
          echo "ASSIGNEE: ${ASSIGNEE}"
          assignee_id=$(echo env.COLLABORATORS | jq --arg key "${{ env.ASSIGNEE }}" '.[$key]')
          echo "ASSIGNEE ID: ${assignee_id}"
          curl -s -X POST \
          --url "${{ env.JIRA_URL }}/rest/api/2/issue/" \
          --header "Content-Type: application/json" \
          --header "Accept: application/json" \
          --user "${{ env.JIRA_AUTH }}" \
          -d '{
            "fields": {
              "project": {
                  "key": "'"${{ env.PROJECT_KEY }}"'"
              },
              "issuetype": {
                  "name": "'"${{ env.ISSUE_TYPE }}"'"
              },
              "summary": "'"${{ steps.pr-details.outputs.title }} - ${GITHUB_REPOSITORY#${GITHUB_OWNER}}#${{ steps.pr-details.outputs.number }}"'",
              "description": "'"${{ env.DESCRIPTION }}"'",
              "assignee": {
                "accountId": "'"${assignee_id}"'"
              }
            }
          }' > jira-issue.json
          cat jira-issue.json
          # Parse issue key from Jira response
          assignee_issue_key=$(cat jira-issue.json | jq -r '.key')
          echo "assignee-issue-key=${assignee_issue_key}" >> $GITHUB_OUTPUT

      - name: Create Jira issues for reviewers
        env:
          DESCRIPTION: ${{ steps.pr-details.outputs.description }}
          ASSIGNEE_ISSUE_KEY: ${{ steps.pr-details.outputs.assignee-issue-key }}
          REVIEWERS: ${{ steps.pr-details.outputs.reviewers }}
          COLLABORATORS: ${{ steps.get-collaborators.outputs.mapped-collaborators }}
        run: |
          for reviewer in $(echo ${{ env.REVIEWERS }} | tr ',' '\n'); do
            key=${reviewer}
            reviewer_id=$(jq -r --arg key "${reviewer}" '.[$key]' <<<"${COLLABORATORS}")
            echo "Reviewer: ${reviewer_id}"
            curl -s -X POST \
            --url "${JIRA_URL}/rest/api/2/issue/" \
            --header "Content-Type: application/json" \
            --header "Accept: application/json" \
            --user "${JIRA_AUTH}" \
            -d '{
              "fields": {
                "project": {
                    "key": "'"${{ env.PROJECT_KEY }}"'"
                  },
                  "parent": {
                    "key": "'"${{ env.ASSIGNEE_ISSUE_KEY }}"'"
                  },
                  "issuetype": {
                    "name": "Sub-task"
                  },
                  "summary": "'"${{ steps.pr-details.outputs.title }} - Review by ${reviewer} - ${GITHUB_REPOSITORY#${GITHUB_OWNER}}#${{ steps.pr-details.outputs.number }}"'",
                  "assignee": {
                    "accountId": "'"${reviewer_id}"'"
                  }
              }
            }
          }' > jira-subtask.json
          SUBTASK_KEY=$(cat jira-subtask.json | jq -r '.key')
          echo "Jira subtask created: ${SUBTASK_KEY}"
          done
